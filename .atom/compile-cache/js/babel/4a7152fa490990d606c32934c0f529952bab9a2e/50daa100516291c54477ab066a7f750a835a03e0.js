"use strict";

var child_process = require("child_process");
var fs = require("fs");
var path = require("path");
var _ = require("lodash");
var XRegExp = require("xregexp").XRegExp;

var SaveConfirmView = require("./save-confirm-view");
var BuildView = require("./build-view");
var tools = require("./tools");

module.exports = {
  config: {
    keepVisible: {
      title: "Keep Visible",
      description: "If the build panel should be kept visible at all times.",
      type: "boolean",
      "default": false
    },
    buildOnSave: {
      title: "Automatically build on save",
      description: "Autmatically build your project each time an editor is saved.",
      type: "boolean",
      "default": false
    },
    saveOnBuild: {
      title: "Automatically save on build",
      description: "Automatically save all edited files when triggering a build.",
      type: "boolean",
      "default": false
    },
    monocleHeight: {
      title: "Monocle Height",
      description: "How much of the workspace to use for build panel when it is \"maximized\".",
      type: "number",
      "default": 0.75,
      minimum: 0.1,
      maximum: 0.9
    },
    minimizedHeight: {
      title: "Minimized Height",
      description: "How much of the workspace to use for build panel when it is \"minimized\".",
      type: "number",
      "default": 0.15,
      minimum: 0.1,
      maximum: 0.9
    }
  },

  activate: function activate(state) {
    // Manually append /usr/local/bin as it may not be set on some systems,
    // and it's common to have node installed here. Keep it at end so it won't
    // accidentially override any other node installation
    process.env.PATH += ":/usr/local/bin";

    this.buildView = new BuildView();
    this.cmd = {};
    this.stdout = new Buffer(0);
    this.stderr = new Buffer(0);
    atom.commands.add("atom-workspace", "build:trigger", this.build.bind(this));
    atom.commands.add("atom-workspace", "build:error-match", this.errorMatch.bind(this));
    atom.commands.add("atom-workspace", "build:stop", this.stop.bind(this));
    atom.commands.add("atom-workspace", "build:confirm", function () {
      document.activeElement.click();
    });
    atom.commands.add("atom-workspace", "build:no-confirm", (function () {
      this.saveConfirmView.cancel();
    }).bind(this));

    atom.workspace.observeTextEditors(function (editor) {
      editor.onDidSave(function (event) {
        if (atom.config.get("build.buildOnSave")) {
          var workspaceElement = atom.views.getView(atom.workspace);
          atom.commands.dispatch(workspaceElement, "build:trigger");
        }
      });
    });
  },

  deactivate: function deactivate() {
    if (this.child) {
      this.child.kill("SIGKILL");
    }
    clearTimeout(this.finishedTimer);
  },

  buildCommand: function buildCommand() {
    var path = atom.project.getPaths()[0]; // Only support root path for now.
    var cmd = {
      env: {},
      args: [],
      cwd: path,
      sh: true,
      errorMatch: ""
    };
    _.find(tools, function (tool) {
      if (!tool.isEligable(path)) {
        return;
      }
      cmd = _.defaults(tool.settings(path), cmd);
      return true;
    });

    return cmd;
  },

  replace: function replace(value) {
    var editor = atom.workspace.getActiveTextEditor();
    if (editor && "untitled" !== editor.getTitle()) {
      var activeFile = fs.realpathSync(editor.getPath());
      value = value.replace("{FILE_ACTIVE}", activeFile);
      value = value.replace("{FILE_ACTIVE_PATH}", path.dirname(activeFile));
      value = value.replace("{FILE_ACTIVE_NAME}", path.basename(activeFile));
      value = value.replace("{FILE_ACTIVE_NAME_BASE}", path.basename(activeFile, path.extname(activeFile)));
    }

    value = value.replace("{PROJECT_PATH}", fs.realpathSync(atom.project.getPaths()[0]));
    if (atom.project.getRepositories[0]) {
      value = value.replace("{REPO_BRANCH_SHORT}", atom.project.getRepositories()[0].getShortHead());
    }

    return value;
  },

  errorMatch: function errorMatch() {
    if (!this.cmd.errorMatch) {
      return;
    }
    var regex = XRegExp(this.cmd.errorMatch);
    var match = XRegExp.exec(this.stderr.toString("utf8"), regex) || XRegExp.exec(this.stdout.toString("utf8"), regex);

    if (!match) {
      return;
    }

    atom.workspace.open(match.file, {
      initialLine: match.line ? match.line - 1 : 0, /* Because atom is zero-based */
      initialColumn: match.col ? match.col - 1 : 0 /* Because atom is zero-based */
    });
  },

  startNewBuild: function startNewBuild() {
    this.cmd = {};
    try {
      this.cmd = this.buildCommand();
    } catch (error) {
      this.buildView.reset();
      this.buildView.errorMessage("You have a syntax error in your build file.", true);
      this.buildView.append(error.message);
      return;
    }

    if (!this.cmd.exec) {
      return;
    }

    var env = _.extend(process.env, this.cmd.env);
    _.each(env, (function (value, key, list) {
      list[key] = this.replace(value);
    }).bind(this));

    var args = _.map(this.cmd.args, this.replace);

    this.cmd.exec = this.replace(this.cmd.exec);

    this.child = child_process.spawn(this.cmd.sh ? "/bin/sh" : this.cmd.exec, this.cmd.sh ? ["-c", [this.cmd.exec].concat(args).join(" ")] : args, { cwd: this.replace(this.cmd.cwd), env: env });

    this.stdout = new Buffer(0);
    this.child.stdout.on("data", (function (buffer) {
      this.stdout = Buffer.concat([this.stdout, buffer]);
      this.buildView.append(buffer);
    }).bind(this));

    this.stderr = new Buffer(0);
    this.child.stderr.on("data", (function (buffer) {
      this.stderr = Buffer.concat([this.stderr, buffer]);
      this.buildView.append(buffer);
    }).bind(this));

    this.child.on("error", (function (err) {
      this.buildView.append((this.cmd.sh ? "Unable to execute with sh: " : "Unable to execute: ") + this.cmd.exec);
      this.buildView.append(/\s/.test(this.cmd.exec) ? "`cmd` cannot contain space. Use `args` for arguments." : "");
    }).bind(this));

    this.child.on("close", (function (exitCode) {
      this.buildView.buildFinished(0 === exitCode);
      if (0 === exitCode) {
        this.finishedTimer = setTimeout((function () {
          this.buildView.detach();
        }).bind(this), 1000);
      }
      this.child = null;
    }).bind(this));

    this.buildView.buildStarted();
    this.buildView.append((this.cmd.sh ? "Executing with sh: " : "Executing: ") + this.cmd.exec + [" "].concat(args).join(" "));
  },

  abort: function abort(cb) {
    this.child.removeAllListeners("close");
    this.child.on("close", (function () {
      this.child = null;
      if (cb) {
        cb();
      }
    }).bind(this));
    this.child.kill();
    this.child.killed = true;
  },

  build: function build() {
    clearTimeout(this.finishedTimer);

    this.doSaveConfirm(this.unsavedTextEditors(), (function () {
      if (this.child) {
        this.abort(this.startNewBuild.bind(this));
      } else {
        this.startNewBuild();
      }
    }).bind(this));
  },

  doSaveConfirm: function doSaveConfirm(modifiedTextEditors, continuecb, cancelcb) {
    var saveAndContinue = function saveAndContinue(save) {
      _.each(modifiedTextEditors, function (textEditor) {
        save && textEditor.save();
      });
      continuecb();
    };

    if (0 === _.size(modifiedTextEditors) || atom.config.get("build.saveOnBuild")) {
      return saveAndContinue(true);
    }

    this.saveConfirmView = new SaveConfirmView();
    this.saveConfirmView.show(saveAndContinue, cancelcb);
  },

  unsavedTextEditors: function unsavedTextEditors() {
    return _.filter(atom.workspace.getTextEditors(), function (textEditor) {
      return textEditor.isModified() && "untitled" !== textEditor.getTitle();
    });
  },

  stop: function stop() {

    clearTimeout(this.finishedTimer);
    if (this.child) {
      if (this.child.killed) {
        // This child has been killed, but hasn't terminated. Hide it from user.
        this.child.removeAllListeners();
        this.child = null;
        this.buildView.buildAborted();
        return;
      }

      this.abort(this.buildView.buildAborted.bind(this.buildView));

      this.buildView.buildAbortInitiated();
    } else {
      this.buildView.reset();
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL29wcy8uYXRvbS9wYWNrYWdlcy9idWlsZC9saWIvYnVpbGQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM3QyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDOztBQUV6QyxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUNyRCxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDeEMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDOztBQUUvQixNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsUUFBTSxFQUFFO0FBQ04sZUFBVyxFQUFFO0FBQ1gsV0FBSyxFQUFFLGNBQWM7QUFDckIsaUJBQVcsRUFBRSx5REFBeUQ7QUFDdEUsVUFBSSxFQUFFLFNBQVM7QUFDZixpQkFBUyxLQUFLO0tBQ2Y7QUFDRCxlQUFXLEVBQUU7QUFDWCxXQUFLLEVBQUUsNkJBQTZCO0FBQ3BDLGlCQUFXLEVBQUUsK0RBQStEO0FBQzVFLFVBQUksRUFBRSxTQUFTO0FBQ2YsaUJBQVMsS0FBSztLQUNmO0FBQ0QsZUFBVyxFQUFFO0FBQ1gsV0FBSyxFQUFFLDZCQUE2QjtBQUNwQyxpQkFBVyxFQUFFLDhEQUE4RDtBQUMzRSxVQUFJLEVBQUUsU0FBUztBQUNmLGlCQUFTLEtBQUs7S0FDZjtBQUNELGlCQUFhLEVBQUU7QUFDYixXQUFLLEVBQUUsZ0JBQWdCO0FBQ3ZCLGlCQUFXLEVBQUUsNEVBQTBF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LEtBQUssQ0FDOUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUN2QyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFFLElBQUksRUFBRSxDQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBRSxHQUFHLElBQUksRUFDdkUsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FDOUMsQ0FBQzs7QUFFRixRQUFJLENBQUMsTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzVCLFFBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQSxVQUFVLE1BQU0sRUFBRTtBQUM3QyxVQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBRSxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBRSxDQUFDLENBQUM7QUFDckQsVUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDL0IsQ0FBQSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOztBQUVkLFFBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDNUIsUUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFBLFVBQVUsTUFBTSxFQUFFO0FBQzdDLFVBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFFLENBQUMsQ0FBQztBQUNyRCxVQUFJLENBQUMsU0FBUyxD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QUMsWUFBWSxFQUFFLENBQUM7QUFDOUIsZUFBTztPQUNSOztBQUVELFVBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDOztBQUU3RCxVQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7S0FDdEMsTUFBTTtBQUNMLFVBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7S0FDeEI7R0FDRjtDQUNGLENBQUMiLCJmaWxlIjoiL2hvbWUvb3BzLy5hdG9tL3BhY2thZ2VzL2J1aWxkL2xpYi9idWlsZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIFhSZWdFeHAgPSByZXF1aXJlKCd4cmVnZXhwJykuWFJlZ0V4cDtcblxudmFyIFNhdmVDb25maXJtVmlldyA9IHJlcXVpcmUoJy4vc2F2ZS1jb25maXJtLXZpZXcnKTtcbnZhciBCdWlsZFZpZXcgPSByZXF1aXJlKCcuL2J1aWxkLXZpZXcnKTtcbnZhciB0b29scyA9IHJlcXVpcmUoJy4vdG9vbHMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNvbmZpZzoge1xuICAgIGtlZXBWaXNpYmxlOiB7XG4gICAgICB0aXRsZTogJ0tlZXAgVmlzaWJsZScsXG4gICAgICBkZXNjcmlwdGlvbjogJ0lmIHRoZSBidWlsZCBwYW5lbCBzaG91bGQgYmUga2VwdCB2aXNpYmxlIGF0IGFsbCB0aW1lcy4nLFxuICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgZGVmYXVsdDogZmFsc2VcbiAgICB9LFxuICAgIGJ1aWxkT25TYXZlOiB7XG4gICAgICB0aXRsZTogJ0F1dG9tYXRpY2FsbHkgYnVpbGQgb24gc2F2ZScsXG4gICAgICBkZXNjcmlwdGlvbjogJ0F1dG1hdGljYWxseSBidWlsZCB5b3VyIHByb2plY3QgZWFjaCB0aW1lIGFuIGVkaXRvciBpcyBzYXZlZC4nLFxuICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgZGVmYXVsdDogZmFsc2VcbiAgICB9LFxuICAgIHNhdmVPbkJ1aWxkOiB7XG4gICAgICB0aXRsZTogJ0F1dG9tYXRpY2FsbHkgc2F2ZSBvbiBidWlsZCcsXG4gICAgICBkZXNjcmlwdGlvbjogJ0F1dG9tYXRpY2FsbHkgc2F2ZSBhbGwgZWRpdGVkIGZpbGVzIHdoZW4gdHJpZ2dlcmluZyBhIGJ1aWxkLicsXG4gICAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgICBkZWZhdWx0OiBmYWxzZVxuICAgIH0sXG4gICAgbW9ub2NsZUhlaWdodDoge1xuICAgICAgdGl0bGU6ICdNb25vY2xlIEhlaWdodCcsXG4gICAgICBkZXNjcmlwdGlvbjogJ0hvdyBtdWNoIG9mIHRoZSB3b3Jrc3BhY2UgdG8gdXNlIGZvciBidWlsZCBwYW5lbCB3aGVuIGl0IGlzIFwibWF4aW1pemVkXCIuJyxcbiAgICAgIHR5cGU6ICdudW1iZXInLFxuICAgICAgZGVmYXVsdDogMC43NSxcbiAgICAgIG1pbmltdW06IDAuMSxcbiAgICAgIG1heGltdW06IDAuOVxuICAgIH0sXG4gICAgbWluaW1pemVkSGVpZ2h0OiB7XG4gICAgICB0aXRsZTogJ01pbmltaXplZCBIZWlnaHQnLFxuICAgICAgZGVzY3JpcHRpb246ICdIb3cgbXVjaCBvZiB0aGUgd29ya3NwYWNlIHRvIHVzZSBmb3IgYnVpbGQgcGFuZWwgd2hlbiBpdCBpcyBcIm1pbmltaXplZFwiLicsXG4gICAgICB0eXBlOiAnbnVtYmVyJyxcbiAgICAgIGRlZmF1bHQ6IDAuMTUsXG4gICAgICBtaW5pbXVtOiAwLjEsXG4gICAgICBtYXhpbXVtOiAwLjlcbiAgICB9XG4gIH0sXG5cbiAgYWN0aXZhdGU6IGZ1bmN0aW9uKHN0YXRlKSB7XG4gICAgLy8gTWFudWFsbHkgYXBwZW5kIC91c3IvbG9jYWwvYmluIGFzIGl0IG1heSBub3QgYmUgc2V0IG9uIHNvbWUgc3lzdGVtcyxcbiAgICAvLyBhbmQgaXQncyBjb21tb24gdG8gaGF2ZSBub2RlIGluc3RhbGxlZCBoZXJlLiBLZWVwIGl0IGF0IGVuZCBzbyBpdCB3b24ndFxuICAgIC8vIGFjY2lkZW50aWFsbHkgb3ZlcnJpZGUgYW55IG90aGVyIG5vZGUgaW5zdGFsbGF0aW9uXG4gICAgcHJvY2Vzcy5lbnYuUEFUSCArPSAnOi91c3IvbG9jYWwvYmluJztcblxuICAgIHRoaXMuYnVpbGRWaWV3ID0gbmV3IEJ1aWxkVmlldygpO1xuICAgIHRoaXMuY21kID0ge307XG4gICAgdGhpcy5zdGRvdXQgPSBuZXcgQnVmZmVyKDApO1xuICAgIHRoaXMuc3RkZXJyID0gbmV3IEJ1ZmZlcigwKTtcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnYnVpbGQ6dHJpZ2dlcicsIHRoaXMuYnVpbGQuYmluZCh0aGlzKSk7XG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywgJ2J1aWxkOmVycm9yLW1hdGNoJywgdGhpcy5lcnJvck1hdGNoLmJpbmQodGhpcykpO1xuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdidWlsZDpzdG9wJywgdGhpcy5zdG9wLmJpbmQodGhpcykpO1xuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdidWlsZDpjb25maXJtJywgZnVuY3Rpb24oKSB7XG4gICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50LmNsaWNrKCk7XG4gICAgfSk7XG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywgJ2J1aWxkOm5vLWNvbmZpcm0nLCBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuc2F2ZUNvbmZpcm1WaWV3LmNhbmNlbCgpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICBlZGl0b3Iub25EaWRTYXZlKGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2J1aWxkLmJ1aWxkT25TYXZlJykpIHtcbiAgICAgICAgICB2YXIgd29ya3NwYWNlRWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSk7XG4gICAgICAgICAgYXRvbS5jb21tYW5kcy5kaXNwYXRjaCh3b3Jrc3BhY2VFbGVtZW50LCAnYnVpbGQ6dHJpZ2dlcicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcblxuICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5jaGlsZCkge1xuICAgICAgdGhpcy5jaGlsZC5raWxsKCdTSUdLSUxMJyk7XG4gICAgfVxuICAgIGNsZWFyVGltZW91dCh0aGlzLmZpbmlzaGVkVGltZXIpO1xuICB9LFxuXG4gIGJ1aWxkQ29tbWFuZDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBhdGggPSBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXTsgLy8gT25seSBzdXBwb3J0IHJvb3QgcGF0aCBmb3Igbm93LlxuICAgIHZhciBjbWQgPSB7XG4gICAgICBlbnY6IHt9LFxuICAgICAgYXJnczogW10sXG4gICAgICBjd2Q6IHBhdGgsXG4gICAgICBzaDogdHJ1ZSxcbiAgICAgIGVycm9yTWF0Y2g6ICcnXG4gICAgfTtcbiAgICBfLmZpbmQodG9vbHMsIGZ1bmN0aW9uICh0b29sKSB7XG4gICAgICBpZiAoIXRvb2wuaXNFbGlnYWJsZShwYXRoKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjbWQgPSBfLmRlZmF1bHRzKHRvb2wuc2V0dGluZ3MocGF0aCksIGNtZCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcblxuICAgIHJldHVybiBjbWQ7XG4gIH0sXG5cbiAgcmVwbGFjZTogZnVuY3Rpb24odmFsdWUpIHtcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIGlmIChlZGl0b3IgJiYgJ3VudGl0bGVkJyAhPT0gZWRpdG9yLmdldFRpdGxlKCkpIHtcbiAgICAgIHZhciBhY3RpdmVGaWxlID0gZnMucmVhbHBhdGhTeW5jKGVkaXRvci5nZXRQYXRoKCkpO1xuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCd7RklMRV9BQ1RJVkV9JywgYWN0aXZlRmlsZSk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoJ3tGSUxFX0FDVElWRV9QQVRIfScsIHBhdGguZGlybmFtZShhY3RpdmVGaWxlKSk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoJ3tGSUxFX0FDVElWRV9OQU1FfScsIHBhdGguYmFzZW5hbWUoYWN0aXZlRmlsZSkpO1xuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCd7RklMRV9BQ1RJVkVfTkFNRV9CQVNFfScsIHBhdGguYmFzZW5hbWUoYWN0aXZlRmlsZSwgcGF0aC5leHRuYW1lKGFjdGl2ZUZpbGUpKSk7XG4gICAgfVxuXG4gICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCd7UFJPSkVDVF9QQVRIfScsIGZzLnJlYWxwYXRoU3luYyhhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXSkpO1xuICAgIGlmIChhdG9tLnByb2plY3QuZ2V0UmVwb3NpdG9yaWVzWzBdKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoJ3tSRVBPX0JSQU5DSF9TSE9SVH0nLCBhdG9tLnByb2plY3QuZ2V0UmVwb3NpdG9yaWVzKClbMF0uZ2V0U2hvcnRIZWFkKCkpO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfSxcblxuICBlcnJvck1hdGNoOiBmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuY21kLmVycm9yTWF0Y2gpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHJlZ2V4ID0gWFJlZ0V4cCh0aGlzLmNtZC5lcnJvck1hdGNoKTtcbiAgICB2YXIgbWF0Y2ggPVxuICAgICAgWFJlZ0V4cC5leGVjKHRoaXMuc3RkZXJyLnRvU3RyaW5nKCd1dGY4JyksIHJlZ2V4KSB8fFxuICAgICAgWFJlZ0V4cC5leGVjKHRoaXMuc3Rkb3V0LnRvU3RyaW5nKCd1dGY4JyksIHJlZ2V4KTtcblxuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhdG9tLndvcmtzcGFjZS5vcGVuKG1hdGNoLmZpbGUsIHtcbiAgICAgIGluaXRpYWxMaW5lOiBtYXRjaC5saW5lID8gbWF0Y2gubGluZSAtIDEgOiAwLCAvKiBCZWNhdXNlIGF0b20gaXMgemVyby1iYXNlZCAqL1xuICAgICAgaW5pdGlhbENvbHVtbjogbWF0Y2guY29sID8gbWF0Y2guY29sIC0gMSA6IDAgLyogQmVjYXVzZSBhdG9tIGlzIHplcm8tYmFzZWQgKi9cbiAgICB9KTtcbiAgfSxcblxuICBzdGFydE5ld0J1aWxkOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNtZCA9IHt9O1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNtZCA9IHRoaXMuYnVpbGRDb21tYW5kKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuYnVpbGRWaWV3LnJlc2V0KCk7XG4gICAgICB0aGlzLmJ1aWxkVmlldy5lcnJvck1lc3NhZ2UoJ1lvdSBoYXZlIGEgc3ludGF4IGVycm9yIGluIHlvdXIgYnVpbGQgZmlsZS4nLCB0cnVlKTtcbiAgICAgIHRoaXMuYnVpbGRWaWV3LmFwcGVuZChlcnJvci5tZXNzYWdlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY21kLmV4ZWMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgZW52ID0gXy5leHRlbmQocHJvY2Vzcy5lbnYsIHRoaXMuY21kLmVudik7XG4gICAgXy5lYWNoKGVudiwgZnVuY3Rpb24odmFsdWUsIGtleSwgbGlzdCkge1xuICAgICAgbGlzdFtrZXldID0gdGhpcy5yZXBsYWNlKHZhbHVlKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdmFyIGFyZ3MgPSBfLm1hcCh0aGlzLmNtZC5hcmdzLCB0aGlzLnJlcGxhY2UpO1xuXG4gICAgdGhpcy5jbWQuZXhlYyA9IHRoaXMucmVwbGFjZSh0aGlzLmNtZC5leGVjKTtcblxuICAgIHRoaXMuY2hpbGQgPSBjaGlsZF9wcm9jZXNzLnNwYXduKFxuICAgICAgdGhpcy5jbWQuc2ggPyAnL2Jpbi9zaCcgOiB0aGlzLmNtZC5leGVjLFxuICAgICAgdGhpcy5jbWQuc2ggPyBbICctYycsIFsgdGhpcy5jbWQuZXhlYyBdLmNvbmNhdChhcmdzKS5qb2luKCcgJykgXSA6IGFyZ3MsXG4gICAgICB7IGN3ZDogdGhpcy5yZXBsYWNlKHRoaXMuY21kLmN3ZCksIGVudjogZW52IH1cbiAgICApO1xuXG4gICAgdGhpcy5zdGRvdXQgPSBuZXcgQnVmZmVyKDApO1xuICAgIHRoaXMuY2hpbGQuc3Rkb3V0Lm9uKCdkYXRhJywgZnVuY3Rpb24gKGJ1ZmZlcikge1xuICAgICAgdGhpcy5zdGRvdXQgPSBCdWZmZXIuY29uY2F0KFsgdGhpcy5zdGRvdXQsIGJ1ZmZlciBdKTtcbiAgICAgIHRoaXMuYnVpbGRWaWV3LmFwcGVuZChidWZmZXIpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLnN0ZGVyciA9IG5ldyBCdWZmZXIoMCk7XG4gICAgdGhpcy5jaGlsZC5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbiAoYnVmZmVyKSB7XG4gICAgICB0aGlzLnN0ZGVyciA9IEJ1ZmZlci5jb25jYXQoWyB0aGlzLnN0ZGVyciwgYnVmZmVyIF0pO1xuICAgICAgdGhpcy5idWlsZFZpZXcuYXBwZW5kKGJ1ZmZlcik7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuY2hpbGQub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICB0aGlzLmJ1aWxkVmlldy5hcHBlbmQoKHRoaXMuY21kLnNoID8gJ1VuYWJsZSB0byBleGVjdXRlIHdpdGggc2g6ICcgOiAnVW5hYmxlIHRvIGV4ZWN1dGU6ICcpICsgdGhpcy5jbWQuZXhlYyk7XG4gICAgICB0aGlzLmJ1aWxkVmlldy5hcHBlbmQoL1xccy8udGVzdCh0aGlzLmNtZC5leGVjKSA/ICdgY21kYCBjYW5ub3QgY29udGFpbiBzcGFjZS4gVXNlIGBhcmdzYCBmb3IgYXJndW1lbnRzLicgOiAnJyk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuY2hpbGQub24oJ2Nsb3NlJywgZnVuY3Rpb24oZXhpdENvZGUpIHtcbiAgICAgIHRoaXMuYnVpbGRWaWV3LmJ1aWxkRmluaXNoZWQoMCA9PT0gZXhpdENvZGUpO1xuICAgICAgaWYgKDAgPT09IGV4aXRDb2RlKSB7XG4gICAgICAgIHRoaXMuZmluaXNoZWRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgdGhpcy5idWlsZFZpZXcuZGV0YWNoKCk7XG4gICAgICAgIH0uYmluZCh0aGlzKSwgMTAwMCk7XG4gICAgICB9XG4gICAgICB0aGlzLmNoaWxkID0gbnVsbDtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5idWlsZFZpZXcuYnVpbGRTdGFydGVkKCk7XG4gICAgdGhpcy5idWlsZFZpZXcuYXBwZW5kKCh0aGlzLmNtZC5zaCA/ICdFeGVjdXRpbmcgd2l0aCBzaDogJyA6ICdFeGVjdXRpbmc6ICcpICsgdGhpcy5jbWQuZXhlYyArIFsgJyAnIF0uY29uY2F0KGFyZ3MpLmpvaW4oJyAnKSk7XG4gIH0sXG5cbiAgYWJvcnQ6IGZ1bmN0aW9uKGNiKSB7XG4gICAgdGhpcy5jaGlsZC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2Nsb3NlJyk7XG4gICAgdGhpcy5jaGlsZC5vbignY2xvc2UnLCBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuY2hpbGQgPSBudWxsO1xuICAgICAgaWYgKGNiKSB7XG4gICAgICAgIGNiKCk7XG4gICAgICB9XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmNoaWxkLmtpbGwoKTtcbiAgICB0aGlzLmNoaWxkLmtpbGxlZCA9IHRydWU7XG4gIH0sXG5cbiAgYnVpbGQ6IGZ1bmN0aW9uKCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLmZpbmlzaGVkVGltZXIpO1xuXG4gICAgdGhpcy5kb1NhdmVDb25maXJtKHRoaXMudW5zYXZlZFRleHRFZGl0b3JzKCksIGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoaXMuY2hpbGQpIHtcbiAgICAgICAgdGhpcy5hYm9ydCh0aGlzLnN0YXJ0TmV3QnVpbGQuYmluZCh0aGlzKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0YXJ0TmV3QnVpbGQoKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcykpO1xuICB9LFxuXG4gIGRvU2F2ZUNvbmZpcm06IGZ1bmN0aW9uKG1vZGlmaWVkVGV4dEVkaXRvcnMsIGNvbnRpbnVlY2IsIGNhbmNlbGNiKSB7XG4gICAgdmFyIHNhdmVBbmRDb250aW51ZSA9IGZ1bmN0aW9uKHNhdmUpIHtcbiAgICAgIF8uZWFjaChtb2RpZmllZFRleHRFZGl0b3JzLCBmdW5jdGlvbih0ZXh0RWRpdG9yKSB7XG4gICAgICAgIHNhdmUgJiYgdGV4dEVkaXRvci5zYXZlKCk7XG4gICAgICB9KTtcbiAgICAgIGNvbnRpbnVlY2IoKTtcbiAgICB9O1xuXG4gICAgaWYgKDAgPT09IF8uc2l6ZShtb2RpZmllZFRleHRFZGl0b3JzKSB8fCBhdG9tLmNvbmZpZy5nZXQoJ2J1aWxkLnNhdmVPbkJ1aWxkJykpIHtcbiAgICAgIHJldHVybiBzYXZlQW5kQ29udGludWUodHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5zYXZlQ29uZmlybVZpZXcgPSBuZXcgU2F2ZUNvbmZpcm1WaWV3KCk7XG4gICAgdGhpcy5zYXZlQ29uZmlybVZpZXcuc2hvdyhzYXZlQW5kQ29udGludWUsIGNhbmNlbGNiKTtcbiAgfSxcblxuICB1bnNhdmVkVGV4dEVkaXRvcnM6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBfLmZpbHRlcihhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLCBmdW5jdGlvbih0ZXh0RWRpdG9yKSB7XG4gICAgICByZXR1cm4gdGV4dEVkaXRvci5pc01vZGlmaWVkKCkgJiYgKCd1bnRpdGxlZCcgIT09IHRleHRFZGl0b3IuZ2V0VGl0bGUoKSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgc3RvcDogZnVuY3Rpb24oKSB7XG5cbiAgICBjbGVhclRpbWVvdXQodGhpcy5maW5pc2hlZFRpbWVyKTtcbiAgICBpZiAodGhpcy5jaGlsZCkge1xuICAgICAgaWYgKHRoaXMuY2hpbGQua2lsbGVkKXtcbiAgICAgICAgLy8gVGhpcyBjaGlsZCBoYXMgYmVlbiBraWxsZWQsIGJ1dCBoYXNuJ3QgdGVybWluYXRlZC4gSGlkZSBpdCBmcm9tIHVzZXIuXG4gICAgICAgIHRoaXMuY2hpbGQucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuY2hpbGQgPSBudWxsO1xuICAgICAgICB0aGlzLmJ1aWxkVmlldy5idWlsZEFib3J0ZWQoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFib3J0KHRoaXMuYnVpbGRWaWV3LmJ1aWxkQWJvcnRlZC5iaW5kKHRoaXMuYnVpbGRWaWV3KSk7XG5cbiAgICAgIHRoaXMuYnVpbGRWaWV3LmJ1aWxkQWJvcnRJbml0aWF0ZWQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5idWlsZFZpZXcucmVzZXQoKTtcbiAgICB9XG4gIH1cbn07XG4iXX0=