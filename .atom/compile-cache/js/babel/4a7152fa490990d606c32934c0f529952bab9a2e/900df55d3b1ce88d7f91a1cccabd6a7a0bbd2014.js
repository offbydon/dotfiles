"use strict";

var _ = require("lodash");
var View = require("atom-space-pen-views").View;
var cscompatability = require("./cscompatability");
var Convert = require("ansi-to-html");

module.exports = (function () {
  function BuildView() {
    View.apply(this, arguments);
    this.titleLoop = ["Building", "Building.", "Building..", "Building..."];
    this.titleLoopIndex = 0;
    this.a2h = new Convert();
    this.monocle = false;
    this.attach();

    atom.config.observe("build.keepVisible", this.visibleFromConfig.bind(this));
    atom.config.observe("build.monocleHeight", this.heightFromConfig.bind(this));
    atom.config.observe("build.minimizedHeight", this.heightFromConfig.bind(this));
  }

  cscompatability["extends"](BuildView, View);

  BuildView.content = function () {
    BuildView.div({ tabIndex: -1, "class": "build tool-panel panel-bottom native-key-bindings" }, function () {
      BuildView.div({ "class": "btn-container pull-right" }, function () {
        BuildView.button({ "class": "btn btn-default icon icon-x", outlet: "closeButton", click: "close" });
        BuildView.button({ "class": "btn btn-default icon icon-chevron-up", outlet: "monocleButton", click: "toggleMonocle" });
        BuildView.button({ "class": "btn btn-default icon icon-trashcan new-row", outlet: "clearButton", click: "clear" });
        BuildView.button({ "class": "btn btn-default icon icon-zap", outlet: "triggerButton", click: "build", title: "Build current project" });
      });

      BuildView.div(function () {
        BuildView.ol({ "class": "output panel-body", outlet: "output" });
      });

      BuildView.div(function () {
        BuildView.h1({ "class": "title panel-heading", outlet: "title" }, "Ready");
      });
    });
  };

  BuildView.prototype.attach = function () {
    if (this.panel) {
      this.panel.destroy();
    }
    this.panel = atom.workspace.addBottomPanel({ item: this });
    this.height = this.output.offset().top + this.output.height();
  };

  BuildView.prototype.detach = function (force) {
    force = force || false;
    if (atom.views.getView(atom.workspace)) {
      atom.views.getView(atom.workspace).focus();
    }
    if (this.panel && (force || !atom.config.get("build.keepVisible"))) {
      this.panel.destroy();
      this.panel = null;
    }
  };

  BuildView.prototype.heightFromConfig = function (val) {
    if (this.monocle) {
      this.setHeightPercent(atom.config.get("build.monocleHeight"));
    } else {
      this.setHeightPercent(atom.config.get("build.minimizedHeight"));
    }
  };

  BuildView.prototype.visibleFromConfig = function (val) {
    val ? this.attach() : this.detach();
  };

  BuildView.prototype.reset = function () {
    clearTimeout(this.titleTimer);
    this.titleTimer = 0;
    this.title.removeClass("success error warning");
    this.output.empty();
    this.title.text("Cleared.");
    this.detach();
  };

  BuildView.prototype.updateTitle = function () {
    this.title.text(this.titleLoop[this.titleLoopIndex]);
    this.titleLoopIndex = (this.titleLoopIndex + 1) % this.titleLoop.length;
    this.titleTimer = setTimeout(this.updateTitle.bind(this), 200);
  };

  BuildView.prototype.close = function (event, element) {
    this.detach(true);
  };

  BuildView.prototype.clear = function (event, element) {
    this.reset();
    this.attach();
  };

  BuildView.prototype.build = function (event, element) {
    atom.commands.dispatch(atom.views.getView(atom.workspace), "build:trigger");
  };

  BuildView.prototype.setHeightPercent = function (percent) {
    var newHeight = percent * this.height;
    this.output.css("height", newHeight + "px");
  };

  BuildView.prototype.toggleMonocle = function (event, element) {
    if (!this.monocle) {
      this.setHeightPercent(atom.config.get("build.monocleHeight"));
      this.monocleButton.removeClass("icon-chevron-up").addClass("icon-chevron-down");
    } else {
      this.setHeightPercent(atom.config.get("build.minimizedHeight"));
      this.monocleButton.removeClass("icon-chevron-down").addClass("icon-chevron-up");
    }
    this.monocle = !this.monocle;
  };

  BuildView.prototype.buildStarted = function () {
    this.reset();
    this.attach();
    this.focus();
    this.updateTitle();
  };

  BuildView.prototype.buildFinished = function (success) {
    this.title.text(success ? "Build finished." : "Build failed.");
    this.title.addClass(success ? "success" : "error");
    clearTimeout(this.titleTimer);
  };

  BuildView.prototype.buildAbortInitiated = function () {
    this.title.text("Build process termination imminent...");
    clearTimeout(this.titleTimer);
    this.title.addClass("error");
  };

  BuildView.prototype.buildAborted = function () {
    this.title.text("Aborted!");
  };

  BuildView.prototype.errorMessage = function (title, error) {
    this.title.text(title);
    if (error) {
      this.title.addClass("error");
    }
    this.attach();
  };

  BuildView.prototype.append = function (line) {
    line = _.escape(line.toString());
    this.output.append("<li>" + this.a2h.toHtml(line) + "</li>");
    this.output.scrollTop(this.output[0].scrollHeight);
  };

  return BuildView;
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL29wcy8uYXRvbS9wYWNrYWdlcy9idWlsZC9saWIvYnVpbGQtdmlldy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUNoRCxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUNuRCxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRXRDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxZQUFXO0FBQzNCLFdBQVMsU0FBUyxHQUFHO0FBQ25CLFFBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQzVCLFFBQUksQ0FBQyxTQUFTLEdBQUcsQ0FDZixVQUFVLEVBQ1YsV0FBVyxFQUNYLFlBQVksRUFDWixhQUFhLENBQ2QsQ0FBQztBQUNGLFFBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLFFBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUN6QixRQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNyQixRQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7O0FBRWQsUUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQzVFLFFBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUM3RSxRQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsRUFBRSxJQUFJLENB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R0FDOUIsQ0FBQzs7QUFFRixXQUFTLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRyxZQUFXO0FBQzVDLFFBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0dBQzdCLENBQUM7O0FBRUYsV0FBUyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsVUFBUyxLQUFLLEVBQUUsS0FBSyxFQUFFO0FBQ3hELFFBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3ZCLFFBQUksS0FBSyxFQUFFO0FBQ1QsVUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDOUI7QUFDRCxRQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7R0FDZixDQUFDOztBQUVGLFdBQVMsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLFVBQVMsSUFBSSxFQUFFO0FBQzFDLFFBQUksR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQ2pDLFFBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQUFBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDO0FBQy9ELFFBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7R0FDcEQsQ0FBQzs7QUFFRixTQUFPLFNBQVMsQ0FBQztDQUNsQixDQUFBLEVBQUcsQ0FBQyIsImZpbGUiOiIvaG9tZS9vcHMvLmF0b20vcGFja2FnZXMvYnVpbGQvbGliL2J1aWxkLXZpZXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgVmlldyA9IHJlcXVpcmUoJ2F0b20tc3BhY2UtcGVuLXZpZXdzJykuVmlldztcbnZhciBjc2NvbXBhdGFiaWxpdHkgPSByZXF1aXJlKCcuL2NzY29tcGF0YWJpbGl0eScpO1xudmFyIENvbnZlcnQgPSByZXF1aXJlKCdhbnNpLXRvLWh0bWwnKTtcblxubW9kdWxlLmV4cG9ydHMgPSAoZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIEJ1aWxkVmlldygpIHtcbiAgICBWaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgdGhpcy50aXRsZUxvb3AgPSBbXG4gICAgICAnQnVpbGRpbmcnLFxuICAgICAgJ0J1aWxkaW5nLicsXG4gICAgICAnQnVpbGRpbmcuLicsXG4gICAgICAnQnVpbGRpbmcuLi4nXG4gICAgXTtcbiAgICB0aGlzLnRpdGxlTG9vcEluZGV4ID0gMDtcbiAgICB0aGlzLmEyaCA9IG5ldyBDb252ZXJ0KCk7XG4gICAgdGhpcy5tb25vY2xlID0gZmFsc2U7XG4gICAgdGhpcy5hdHRhY2goKTtcblxuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ2J1aWxkLmtlZXBWaXNpYmxlJywgdGhpcy52aXNpYmxlRnJvbUNvbmZpZy5iaW5kKHRoaXMpKTtcbiAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKCdidWlsZC5tb25vY2xlSGVpZ2h0JywgdGhpcy5oZWlnaHRGcm9tQ29uZmlnLmJpbmQodGhpcykpO1xuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ2J1aWxkLm1pbmltaXplZEhlaWdodCcsIHRoaXMuaGVpZ2h0RnJvbUNvbmZpZy5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIGNzY29tcGF0YWJpbGl0eS5leHRlbmRzKEJ1aWxkVmlldywgVmlldyk7XG5cbiAgQnVpbGRWaWV3LmNvbnRlbnQgPSBmdW5jdGlvbigpIHtcbiAgICBCdWlsZFZpZXcuZGl2KHsgdGFiSW5kZXg6IC0xLCBjbGFzczogJ2J1aWxkIHRvb2wtcGFuZWwgcGFuZWwtYm90dG9tIG5hdGl2ZS1rZXktYmluZGluZ3MnIH0sIGZ1bmN0aW9uKCkge1xuICAgICAgQnVpbGRWaWV3LmRpdih7IGNsYXNzOiAnYnRuLWNvbnRhaW5lciBwdWxsLXJpZ2h0JyB9LCBmdW5jdGlvbigpIHtcbiAgICAgICAgQnVpbGRWaWV3LmJ1dHRvbih7IGNsYXNzOiAnYnRuIGJ0bi1kZWZhdWx0IGljb24gaWNvbi14Jywgb3V0bGV0OiAnY2xvc2VCdXR0b24nLCBjbGljazogJ2Nsb3NlJyB9KTtcbiAgICAgICAgQnVpbGRWaWV3LmJ1dHRvbih7IGNsYXNzOiAnYnRuIGJ0bi1kZWZhdWx0IGljb24gaWNvbi1jaGV2cm9uLXVwJywgb3V0bGV0OiAnbW9ub2NsZUJ1dHRvbicsIGNsaWNrOiAndG9nZ2xlTW9ub2NsZScgfSk7XG4gICAgICAgIEJ1aWxkVmlldy5idXR0b24oeyBjbGFzczogJ2J0biBidG4tZGVmYXVsdCBpY29uIGljb24tdHJhc2hjYW4gbmV3LXJvdycsIG91dGxldDogJ2NsZWFyQnV0dG9uJywgY2xpY2s6ICdjbGVhcicgfSk7XG4gICAgICAgIEJ1aWxkVmlldy5idXR0b24oeyBjbGFzczogJ2J0biBidG4tZGVmYXVsdCBpY29uIGljb24temFwJywgb3V0bGV0OiAndHJpZ2dlckJ1dHRvbicsIGNsaWNrOiAnYnVpbGQnLCB0aXRsZTogJ0J1aWxkIGN1cnJlbnQgcHJvamVjdCcgfSk7XG4gICAgICB9KTtcblxuICAgICAgQnVpbGRWaWV3LmRpdihmdW5jdGlvbigpIHtcbiAgICAgICAgQnVpbGRWaWV3Lm9sKHsgY2xhc3M6ICdvdXRwdXQgcGFuZWwtYm9keScsIG91dGxldDogJ291dHB1dCcgfSk7XG4gICAgICB9KTtcblxuICAgICAgQnVpbGRWaWV3LmRpdihmdW5jdGlvbigpIHtcbiAgICAgICAgQnVpbGRWaWV3LmgxKHsgY2xhc3M6ICd0aXRsZSBwYW5lbC1oZWFkaW5nJywgb3V0bGV0OiAndGl0bGUnIH0sICdSZWFkeScpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5hdHRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5wYW5lbCkge1xuICAgICAgdGhpcy5wYW5lbC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMucGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRCb3R0b21QYW5lbCh7IGl0ZW06IHRoaXMgfSk7XG4gICAgdGhpcy5oZWlnaHQgPSB0aGlzLm91dHB1dC5vZmZzZXQoKS50b3AgKyB0aGlzLm91dHB1dC5oZWlnaHQoKTtcbiAgfTtcblxuICBCdWlsZFZpZXcucHJvdG90eXBlLmRldGFjaCA9IGZ1bmN0aW9uKGZvcmNlKSB7XG4gICAgZm9yY2UgPSBmb3JjZSB8fMKgZmFsc2U7XG4gICAgaWYgKGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkpIHtcbiAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkuZm9jdXMoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucGFuZWwgJiYgKGZvcmNlIHx8ICEoYXRvbS5jb25maWcuZ2V0KCdidWlsZC5rZWVwVmlzaWJsZScpKSkpIHtcbiAgICAgIHRoaXMucGFuZWwuZGVzdHJveSgpO1xuICAgICAgdGhpcy5wYW5lbCA9IG51bGw7XG4gICAgfVxuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUuaGVpZ2h0RnJvbUNvbmZpZyA9IGZ1bmN0aW9uKHZhbCkge1xuICAgIGlmICh0aGlzLm1vbm9jbGUpIHtcbiAgICAgIHRoaXMuc2V0SGVpZ2h0UGVyY2VudChhdG9tLmNvbmZpZy5nZXQoJ2J1aWxkLm1vbm9jbGVIZWlnaHQnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0SGVpZ2h0UGVyY2VudChhdG9tLmNvbmZpZy5nZXQoJ2J1aWxkLm1pbmltaXplZEhlaWdodCcpKTtcbiAgICB9XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS52aXNpYmxlRnJvbUNvbmZpZyA9IGZ1bmN0aW9uKHZhbCkge1xuICAgIHZhbCA/IHRoaXMuYXR0YWNoKCkgOiB0aGlzLmRldGFjaCgpO1xuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHtcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aXRsZVRpbWVyKTtcbiAgICB0aGlzLnRpdGxlVGltZXIgPSAwO1xuICAgIHRoaXMudGl0bGUucmVtb3ZlQ2xhc3MoJ3N1Y2Nlc3MgZXJyb3Igd2FybmluZycpO1xuICAgIHRoaXMub3V0cHV0LmVtcHR5KCk7XG4gICAgdGhpcy50aXRsZS50ZXh0KCdDbGVhcmVkLicpO1xuICAgIHRoaXMuZGV0YWNoKCk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS51cGRhdGVUaXRsZSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMudGl0bGUudGV4dCh0aGlzLnRpdGxlTG9vcFt0aGlzLnRpdGxlTG9vcEluZGV4XSk7XG4gICAgdGhpcy50aXRsZUxvb3BJbmRleCA9ICh0aGlzLnRpdGxlTG9vcEluZGV4ICsgMSkgJSB0aGlzLnRpdGxlTG9vcC5sZW5ndGg7XG4gICAgdGhpcy50aXRsZVRpbWVyID0gc2V0VGltZW91dCh0aGlzLnVwZGF0ZVRpdGxlLmJpbmQodGhpcyksIDIwMCk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uKGV2ZW50LCBlbGVtZW50KSB7XG4gICAgdGhpcy5kZXRhY2godHJ1ZSk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKGV2ZW50LCBlbGVtZW50KSB7XG4gICAgdGhpcy5yZXNldCgpO1xuICAgIHRoaXMuYXR0YWNoKCk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKGV2ZW50LCBlbGVtZW50KSB7XG4gICAgYXRvbS5jb21tYW5kcy5kaXNwYXRjaChhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLCAnYnVpbGQ6dHJpZ2dlcicpO1xuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUuc2V0SGVpZ2h0UGVyY2VudCA9IGZ1bmN0aW9uKHBlcmNlbnQpIHtcbiAgICB2YXIgbmV3SGVpZ2h0ID0gcGVyY2VudCAqIHRoaXMuaGVpZ2h0O1xuICAgIHRoaXMub3V0cHV0LmNzcygnaGVpZ2h0JywgbmV3SGVpZ2h0ICsgJ3B4Jyk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS50b2dnbGVNb25vY2xlID0gZnVuY3Rpb24oZXZlbnQsIGVsZW1lbnQpIHtcbiAgICBpZiAoIXRoaXMubW9ub2NsZSkge1xuICAgICAgdGhpcy5zZXRIZWlnaHRQZXJjZW50KGF0b20uY29uZmlnLmdldCgnYnVpbGQubW9ub2NsZUhlaWdodCcpKTtcbiAgICAgIHRoaXMubW9ub2NsZUJ1dHRvbi5yZW1vdmVDbGFzcygnaWNvbi1jaGV2cm9uLXVwJykuYWRkQ2xhc3MoJ2ljb24tY2hldnJvbi1kb3duJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0SGVpZ2h0UGVyY2VudChhdG9tLmNvbmZpZy5nZXQoJ2J1aWxkLm1pbmltaXplZEhlaWdodCcpKTtcbiAgICAgIHRoaXMubW9ub2NsZUJ1dHRvbi5yZW1vdmVDbGFzcygnaWNvbi1jaGV2cm9uLWRvd24nKS5hZGRDbGFzcygnaWNvbi1jaGV2cm9uLXVwJyk7XG4gICAgfVxuICAgIHRoaXMubW9ub2NsZSA9ICF0aGlzLm1vbm9jbGU7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5idWlsZFN0YXJ0ZWQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnJlc2V0KCk7XG4gICAgdGhpcy5hdHRhY2goKTtcbiAgICB0aGlzLmZvY3VzKCk7XG4gICAgdGhpcy51cGRhdGVUaXRsZSgpO1xuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUuYnVpbGRGaW5pc2hlZCA9IGZ1bmN0aW9uKHN1Y2Nlc3MpIHtcbiAgICB0aGlzLnRpdGxlLnRleHQoc3VjY2VzcyA/ICdCdWlsZCBmaW5pc2hlZC4nIDogJ0J1aWxkIGZhaWxlZC4nKTtcbiAgICB0aGlzLnRpdGxlLmFkZENsYXNzKHN1Y2Nlc3MgPyAnc3VjY2VzcycgOiAnZXJyb3InKTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aXRsZVRpbWVyKTtcbiAgfTtcblxuICBCdWlsZFZpZXcucHJvdG90eXBlLmJ1aWxkQWJvcnRJbml0aWF0ZWQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnRpdGxlLnRleHQoJ0J1aWxkIHByb2Nlc3MgdGVybWluYXRpb24gaW1taW5lbnQuLi4nKTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aXRsZVRpbWVyKTtcbiAgICB0aGlzLnRpdGxlLmFkZENsYXNzKCdlcnJvcicpO1xuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUuYnVpbGRBYm9ydGVkID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy50aXRsZS50ZXh0KCdBYm9ydGVkIScpO1xuICB9O1xuXG4gIEJ1aWxkVmlldy5wcm90b3R5cGUuZXJyb3JNZXNzYWdlID0gZnVuY3Rpb24odGl0bGUsIGVycm9yKSB7XG4gICAgdGhpcy50aXRsZS50ZXh0KHRpdGxlKTtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHRoaXMudGl0bGUuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgfVxuICAgIHRoaXMuYXR0YWNoKCk7XG4gIH07XG5cbiAgQnVpbGRWaWV3LnByb3RvdHlwZS5hcHBlbmQgPSBmdW5jdGlvbihsaW5lKSB7XG4gICAgbGluZSA9IF8uZXNjYXBlKGxpbmUudG9TdHJpbmcoKSk7XG4gICAgdGhpcy5vdXRwdXQuYXBwZW5kKCc8bGk+JyArICh0aGlzLmEyaC50b0h0bWwobGluZSkpICsgJzwvbGk+Jyk7XG4gICAgdGhpcy5vdXRwdXQuc2Nyb2xsVG9wKHRoaXMub3V0cHV0WzBdLnNjcm9sbEhlaWdodCk7XG4gIH07XG5cbiAgcmV0dXJuIEJ1aWxkVmlldztcbn0pKCk7XG4iXX0=